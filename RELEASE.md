# Release Process

This document describes the process for creating a new release of StreamV3.

## Pre-Release Checklist

Before creating a new release tag, ensure:

1. ✅ All code changes are complete and tested
2. ✅ Documentation is updated (especially CLI codelab if CLI changed)
3. ✅ CHANGELOG is updated with new features/fixes
4. ✅ **Version files are generated from git tag**

## Release Steps

**⚠️ CRITICAL: Follow these steps in EXACT order to avoid version mismatch issues!**

### Complete Release Workflow

```bash
# 1. Make all code changes and commit them
git add .
git commit -m "Description of changes"

# 2. Create annotated tag (this sets the version for git describe)
git tag -a vX.Y.Z -m "vX.Y.Z: Brief description

## What's New
- Feature 1
- Feature 2

## Bug Fixes
- Fix 1
"

# 3. Generate version.txt from the tag
./scripts/generate-version.sh
# This will output: "Version updated to: vX.Y.Z"

# 4. Commit the version.txt file
git add cmd/streamv3/version/version.txt
git commit -m "Update version to vX.Y.Z"

# 5. Move the tag to the new commit (so tag includes version.txt)
git tag -d vX.Y.Z
git tag -a vX.Y.Z -m "vX.Y.Z: Brief description

## What's New
- Feature 1
- Feature 2
"

# 6. VERIFY the tag contains correct version.txt
git cat-file -p vX.Y.Z:cmd/streamv3/version/version.txt
# Must show: vX.Y.Z (NOT vX.Y.Z-1-gabcd123)

# 7. Push commit and tag
git push && git push --tags

# 8. Wait a moment for GitHub to process, then verify
sleep 3
GOPROXY=direct go install github.com/rosscartlidge/streamv3/cmd/streamv3@vX.Y.Z
streamv3 -version
# Must show: streamv3 version vX.Y.Z
```

### Why This Order Matters

The workflow creates a chicken-and-egg situation:
- `git describe --tags` needs a tag to generate the correct version
- But the tag should point to a commit that includes the correct version.txt

**Solution:** Create tag → generate version → commit version → move tag

**Common Mistakes:**
- ❌ Committing version.txt before creating tag → version will be `vX.Y.Z-1-gabcd123` (includes commit hash)
- ❌ Not moving tag to new commit → tag points to commit without version.txt
- ❌ Reusing version numbers after failed release → Go checksum database will reject it
- ❌ Using `git commit --amend` after creating tag → tag points to old commit


## Version Numbering

We follow semantic versioning (semver):

- **Major (X.0.0)**: Breaking changes to API or CLI
- **Minor (0.X.0)**: New features, backward compatible
- **Patch (0.0.X)**: Bug fixes, backward compatible

Examples:
- `v0.7.0` - Added Phase 1 SQL operations (JOIN, DISTINCT, OFFSET, UNION)
- `v0.7.1` - Complete code generation with Chain() pattern
- `v0.7.2` - Added regexp/regex aliases (minor improvement)
- `v0.7.3` - Fixed version string display (patch fix)

## How Version Detection Works

The version system uses `git describe --tags` to automatically derive the version:

**Version Sources (in order of precedence):**
1. **Exact tag match**: If HEAD is exactly at a tag (e.g., `v1.0.0`), that's the version
2. **Commits after tag**: If there are commits after the last tag, version includes commit info (e.g., `v1.0.0-1-g15c5228`)
3. **No tags**: Falls back to `v0.0.0-dev`

**Version File:**
- `cmd/streamv3/version/version.txt` - Embedded into version package via `//go:embed`
- Generated by `scripts/generate-version.sh` from `git describe --tags`

**Benefits:**
- ✅ No manual version updates needed
- ✅ Version in binary always matches git tag
- ✅ Generated code comments show correct version
- ✅ Development builds show commit info (e.g., `v1.0.0-5-g3458649`)

## Common Mistakes to Avoid

### ❌ Forgetting to run generate-version.sh
The version.txt files won't update automatically.

**Solution:** Always run `./scripts/generate-version.sh` before committing

### ❌ Forgetting to push tags
Tags are not pushed by default with `git push`.

**Solution:** Always use `git push --tags` or `git push && git push --tags`

### ❌ Using lightweight tags instead of annotated tags
Lightweight tags don't include metadata.

**Solution:** Always use `git tag -a` for releases

## Troubleshooting

### If version.txt is out of sync

```bash
# Regenerate version file from git
./scripts/generate-version.sh

# Commit the updated file
git add cmd/streamv3/version/version.txt
git commit -m "Sync version file with git tag"
```

### If you need to update an existing tag

If you've already created and pushed a tag but need to update it:

```bash
# 1. Make your changes and commit
git add .
git commit -m "Fix for vX.Y.Z"

# 2. Delete old tag locally and remotely
git tag -d vX.Y.Z
git push origin :refs/tags/vX.Y.Z

# 3. Regenerate version file
./scripts/generate-version.sh

# 4. Commit version file
git add cmd/streamv3/version/version.txt
git commit -m "Update version to vX.Y.Z"

# 5. Create new tag
git tag -a vX.Y.Z -m "Updated release notes..."

# 6. Push commit and tag
git push && git push --tags
```

**Better:** Just increment to the next patch version and do it correctly.

## Release Announcement

After release:
1. Update GitHub releases page with tag notes
2. Announce in relevant channels
3. Update README if needed

---

**Remember**: The version string in `cmd/streamv3/main.go` must match the git tag!
